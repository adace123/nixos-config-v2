name: Update Flake Lock
on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: "0 0 * * *"
  workflow_dispatch:
permissions:
  contents: write
  pull-requests: write
jobs:
  update:
    runs-on: macos-latest
    outputs:
      pr-number: ${{ steps.update.outputs.pull-request-number }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
      - name: Update flake.lock
        id: update
        uses: DeterminateSystems/update-flake-lock@main
        with:
          pr-title: "chore(flake): update flake.lock"
          pr-labels: |
            dependencies
            automated
          commit-msg: "chore(flake): update flake.lock"
  # Build and show diff of what would change
  build-and-diff:
    needs: update
    runs-on: macos-latest
    if: needs.update.outputs.pr-number != ''
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref }}
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
      - name: Build and show diff
        id: diff
        run: |
          # Build the new configuration
          nix build .#darwinConfigurations.$(hostname -s).system -o ./result-new

          # Get current system path (if available)
          CURRENT_SYSTEM="/run/current-system"
          if [ -d "$CURRENT_SYSTEM" ]; then
            # Use nvd to show diff between current and new
            echo "## Package Changes" > diff.md
            echo "" >> diff.md
            echo '```' >> diff.md
            nix run nixpkgs#nvd -- diff "$CURRENT_SYSTEM" ./result-new >> diff.md 2>&1 || echo "Unable to diff against current system" >> diff.md
            echo '```' >> diff.md
          else
            echo "## Build Status" > diff.md
            echo "" >> diff.md
            echo "âœ… Configuration builds successfully" >> diff.md
            echo "" >> diff.md
            echo "Note: Cannot show package diff (no current system available in CI)" >> diff.md
          fi

          echo "diff-content<<EOF" >> "$GITHUB_OUTPUT"
          cat diff.md >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
      - name: Comment PR with diff
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ needs.update.outputs.pr-number }}
          body: ${{ steps.diff.outputs.diff-content }}
          edit-mode: replace
  auto-merge:
    needs: [update, build-and-diff]
    runs-on: macos-latest
    if: needs.update.outputs.pr-number != ''
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Enable auto-merge
        run: |
          gh pr merge ${{ needs.update.outputs.pr-number }} --auto --squash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
