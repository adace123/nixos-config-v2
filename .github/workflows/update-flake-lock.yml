name: Update Flake Lock
on:
  schedule:
    # Run weekdays at 8:00 AM Pacific Time (16:00 UTC)
    - cron: "0 16 * * 1-5"
  workflow_dispatch:
concurrency:
  group: update-flake-lock
  cancel-in-progress: true
permissions:
  contents: write
  pull-requests: write
jobs:
  update:
    runs-on: macos-latest
    outputs:
      pr-number: ${{ steps.update.outputs.pull-request-number }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
      - name: Cache Nix store
        uses: DeterminateSystems/magic-nix-cache-action@main
      - name: Update flake.lock
        id: update
        uses: DeterminateSystems/update-flake-lock@main
        with:
          pr-title: "chore(flake): update flake.lock"
          pr-labels: |
            dependencies
            automated
          commit-msg: "chore(flake): update flake.lock"
  build-and-diff:
    needs: update
    runs-on: macos-latest
    if: needs.update.outputs.pr-number != ''
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
      - name: Cache Nix store
        uses: DeterminateSystems/magic-nix-cache-action@main
      - name: Install nvd
        run: nix profile install nixpkgs#nvd
      - name: Get main flake.lock hash
        id: main-hash
        run: |
          git checkout origin/main
          echo "hash=$(sha256sum flake.lock | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
      - name: Restore cached main build
        id: cache-main
        uses: actions/cache@v4
        with:
          path: ./result-main
          key: nix-darwin-main-${{ steps.main-hash.outputs.hash }}
      - name: Build main branch (baseline)
        if: steps.cache-main.outputs.cache-hit != 'true'
        run: |
          git checkout origin/main
          nix build .#darwinConfigurations.endor.system -o ./result-main
      - name: Build PR branch (new)
        run: |
          git checkout -
          nix build .#darwinConfigurations.endor.system -o ./result-pr
      - name: Generate package diff
        id: diff
        run: |
          echo "## Package Changes" > diff.md
          echo "" >> diff.md
          echo "Comparing current system (main) with updated flake.lock:" >> diff.md
          echo "" >> diff.md
          echo '```' >> diff.md
          nvd diff ./result-main ./result-pr >> diff.md 2>&1 || true
          echo '```' >> diff.md
          echo "" >> diff.md
          echo "### Build Status" >> diff.md
          echo "âœ… Configuration builds successfully with updated flake.lock" >> diff.md
          echo "diff-content<<EOF" >> "$GITHUB_OUTPUT"
          cat diff.md >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
      - name: Comment PR with diff
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ needs.update.outputs.pr-number }}
          body: ${{ steps.diff.outputs.diff-content }}
          edit-mode: replace
  auto-merge:
    needs: [update, build-and-diff]
    runs-on: macos-latest
    if: needs.update.outputs.pr-number != '' && needs.build-and-diff.result == 'success'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Enable auto-merge
        run: |
          gh pr merge ${{ needs.update.outputs.pr-number }} --auto --squash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
